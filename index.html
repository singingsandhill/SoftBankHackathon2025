<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Deploy Â· GitHub Actions</title>
    <style>
      :root{
        --bg:#0b1220;--fg:#e5e7eb;--muted:#9ca3af;--accent:#7c3aed;--ok:#10b981;--err:#ef4444;--warn:#f59e0b
      }
      *{box-sizing:border-box}
      html,body{height:100%;margin:0;padding:0}
      body{display:grid;place-items:center;background:radial-gradient(800px 500px at 10% 0%, #121a2f, #0b1220);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;padding:20px}
      .card{width:min(520px,100%);background:rgba(255,255,255,.04);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.08);border-radius:18px;box-shadow:0 12px 30px rgba(0,0,0,.35);padding:22px}
      h1{margin:0 0 8px;font-size:18px}
      p{margin:0 0 12px;color:var(--muted);font-size:14px}
      .input-group{margin-bottom:14px}
      .input-group label{display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--fg)}
      .input-group input{width:100%;padding:10px 12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:10px;color:var(--fg);font-size:14px;font-family:ui-monospace,Menlo,Consolas,monospace}
      .input-group input:focus{outline:none;border-color:var(--accent);background:rgba(255,255,255,.08)}
      .btn{appearance:none;border:0;border-radius:14px;padding:14px 18px;font-weight:800;letter-spacing:.2px;cursor:pointer;background:linear-gradient(180deg,var(--accent),#6d28d9);color:white;box-shadow:0 10px 20px rgba(124,58,237,.35);width:100%;margin-top:8px}
      .btn[disabled]{opacity:.6;cursor:not-allowed}
      .btn-secondary{background:linear-gradient(180deg,#374151,#1f2937);box-shadow:0 10px 20px rgba(0,0,0,.2)}
      .status{margin-top:14px;padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;word-break:break-all}
      .ok{color:var(--ok)}
      .err{color:var(--err)}
      .warn{color:var(--warn)}
      .hint{margin-top:10px;padding:10px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:8px;font-size:12px;color:#fca5a5}
      .kbd{font-family:ui-monospace,Menlo,monospace;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-bottom-width:2px;padding:1px 6px;border-radius:6px}
      .small{font-size:12px}
      .token-saved{display:none;align-items:center;gap:8px;padding:8px 12px;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);border-radius:8px;font-size:12px;color:var(--ok);margin-bottom:12px}
      .token-saved.show{display:flex}
      .iframe-container{margin-top:20px}
      .iframe-container h3{margin:0 0 10px;font-size:16px;color:var(--fg)}
      .iframe-container iframe{width:100%;height:400px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:rgba(255,255,255,.02)}
      .link{color:var(--accent);text-decoration:none;font-weight:600}
      .link:hover{text-decoration:underline}
    </style>
  </head>
  <body>
    <div class="card">
      <h1>ğŸš€ GitHub Actions ë°°í¬ íŠ¸ë¦¬ê±°</h1>
      <p class="small">ë²„íŠ¼ í•˜ë‚˜ë¡œ <span class="kbd">workflow_dispatch</span> ì´ë²¤íŠ¸ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.</p>

      <div id="tokenSaved" class="token-saved">
        <span>âœ“</span>
        <span>í† í°ì´ ì„¸ì…˜ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ (íƒ­ ë‹«ìœ¼ë©´ ì‚­ì œ)</span>
      </div>

      <div class="input-group">
        <label for="tokenInput">
          GitHub Personal Access Token
        </label>
        <input 
          type="password" 
          id="tokenInput" 
          placeholder="ghp_xxxxxxxxxxxxxxxxxx"
          autocomplete="off"
        />
      </div>

      <button id="saveBtn" class="btn btn-secondary" type="button">ğŸ’¾ í† í° ì €ì¥ (ì„¸ì…˜)</button>
      <button id="deployBtn" class="btn" type="button">ğŸš€ ë°°í¬ ì‹¤í–‰</button>
      
      <div id="status" class="status" role="status" aria-live="polite">ëŒ€ê¸° ì¤‘â€¦</div>
      
      <div class="hint">
        <strong>âš ï¸ ë³´ì•ˆ ì£¼ì˜ì‚¬í•­:</strong><br>
        â€¢ Personal Access Tokenì€ <strong>Actions: write</strong>, <strong>Contents: read</strong>, <strong>Metadata: read</strong> ê¶Œí•œ í•„ìš”<br>
        â€¢ í† í°ì€ sessionStorageì—ë§Œ ì €ì¥ (íƒ­ ë‹«ìœ¼ë©´ ìë™ ì‚­ì œ)<br>
        â€¢ <strong>ì ˆëŒ€ í† í°ì„ ê³µìœ í•˜ê±°ë‚˜ ì»¤ë°‹í•˜ì§€ ë§ˆì„¸ìš”</strong><br>
        â€¢ Fine-grained token ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤
      </div>
      
      <div class="iframe-container">
        <h3>ğŸŒ Eureka Service Registry</h3>
        <iframe src="http://3.34.94.55:8761/" title="Eureka Server Dashboard" frameborder="0"></iframe>
      </div>
    </div>

    <script>
      // ====== ë ˆí¬ì§€í† ë¦¬ ì„¤ì • (ìˆ˜ì • í•„ìš”) ======
      const CONFIG = {
        owner: 'SoftBankHackathon2025',             // GitHub ì‚¬ìš©ìëª…
        repo: 'Raspberry',        // ë ˆí¬ì§€í† ë¦¬ëª…
        workflow_id: 'ci-cd.yml',            // ì›Œí¬í”Œë¡œìš° íŒŒì¼ëª…
        ref: 'feat/LandingPage'                           // ë¸Œëœì¹˜ëª…
      };
      // ========================================

      const $ = (s) => document.querySelector(s);
      const statusEl = $('#status');
      const deployBtn = $('#deployBtn');
      const saveBtn = $('#saveBtn');
      const tokenInput = $('#tokenInput');
      // const envInput = $('#envInput');
      const tokenSaved = $('#tokenSaved');

      function setStatus(text, cls){
        statusEl.className = 'status' + (cls ? ' ' + cls : '');
        statusEl.textContent = text;
      }

      // ì„¸ì…˜ì—ì„œ í† í° ë¡œë“œ
      function loadToken(){
        const saved = sessionStorage.getItem('gh_token');
        if(saved){
          tokenInput.value = saved;
          tokenSaved.classList.add('show');
        }
      }

      // í† í° ì €ì¥
      saveBtn.addEventListener('click', function(){
        const token = tokenInput.value.trim();
        if(!token){
          setStatus('âŒ í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'err');
          return;
        }
        sessionStorage.setItem('gh_token', token);
        tokenSaved.classList.add('show');
        setStatus('âœ… í† í°ì´ ì„¸ì…˜ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'ok');
      });

      // ë°°í¬ íŠ¸ë¦¬ê±°
      async function triggerDispatch(){
        const token = tokenInput.value.trim();
        // const environment = envInput.value.trim() || 'stg';
        
        if(!token){
          setStatus('âŒ GitHub Tokenì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'err');
          tokenInput.focus();
          return;
        }

        deployBtn.disabled = true;
        setStatus('ìš”ì²­ ì „ì†¡ ì¤‘â€¦');

        const {owner, repo, workflow_id, ref} = CONFIG;
        const url = `https://api.github.com/repos/${owner}/${repo}/actions/workflows/${workflow_id}/dispatches`;
        
        try {
          const res = await fetch(url, {
            method: 'POST',
            headers: {
              'Accept': 'application/vnd.github+json',
              'Authorization': `Bearer ${token}`,
              'X-GitHub-Api-Version': '2022-11-28',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
              ref,
              inputs: { env: 'dev' }
            })
          });

          if(res.status === 204){
            setStatus(`âœ… íŠ¸ë¦¬ê±° ì„±ê³µ! ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. (í™˜ê²½: dev)`, 'ok');
            setTimeout(() => {
              const actionsUrl = `https://github.com/${owner}/${repo}/actions`;
              setStatus(`GitHub Actions íƒ­ì—ì„œ í™•ì¸: ${actionsUrl}`, 'ok');
            }, 2000);
          } else {
            const text = await res.text();
            let errorMsg = `HTTP ${res.status}`;
            try {
              const json = JSON.parse(text);
              errorMsg += ` â€” ${json.message || text}`;
            } catch {
              errorMsg += ` â€” ${text || 'ì‘ë‹µ ë³¸ë¬¸ ì—†ìŒ'}`;
            }
            setStatus(`âŒ ì‹¤íŒ¨: ${errorMsg}`, 'err');
          }
        } catch (e){
          setStatus('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + (e?.message || e), 'err');
        } finally {
          deployBtn.disabled = false;
        }
      }

      deployBtn.addEventListener('click', triggerDispatch);
      
      // ì—”í„°í‚¤ë¡œ ë°°í¬
      // tokenInput.addEventListener('keypress', (e) => {
      //   if(e.key === 'Enter') triggerDispatch();
      // });

      // í˜ì´ì§€ ë¡œë“œ ì‹œ í† í° ë³µì›
      loadToken();
    </script>
  </body>
</html>